## 第 13 章
# 现实世界中的领域驱动设计

我们已经涵盖了领域驱动的设计工具，用于分析业务领域，分享知识，并做出战略和战术设计决策。试想一下，在实践中应用这些知识将会多么有趣。让我们考虑一个你正在处理的新建项目（greenfield project）的场景。你所有的同事都非常了解领域驱动设计，从一开始，所有人都在尽最大努力设计有效的模型，当然，他们也都致力于使用通用语言。随着项目的推进，限界上下文的边界是明确的，并能有效保护业务领域模型。最后，由于所有战术设计决策都与业务战略保持一致，因此代码库始终处于良好状态：它使用通用语言并实现适应模型复杂性的设计模式。现在醒醒吧。

你经历我刚才描述的实验室条件的机会就像中彩票一样低。当然，这是有可能的，只是可能性不大。不幸的是，许多人错误地认为领域驱动设计只能在新建项目中应用，而且是在团队中每个人都是 DDD 黑带的理想情况下。具有讽刺意味的是，最能从 DDD 中受益的项目是既有项目（brownfield projects）：那些已经证明了其商业可行性并需要进行调整以对抗累积的技术债务及设计熵的项目。巧合的是，我们大部分的软件工程职业生涯都花在处理这样的既有的、遗留的、大泥球代码库上。

关于 DDD 的另一个常见误解是，它是一个非黑即白的命题--要么你应用该方法论所提供的每一个工具，要么它就不是领域驱动设计。这并不正确。要掌握所有这些概念，可能就会让人显得力不从心，更不用说实践它们了。幸运的是，你不需要应用所有的模式和实践来获得领域驱动设计的价值。这对于既有项目来说尤其如此，在合理的时间范围内引入所有的模式和实践实际上是不可能的。

在本章中，你将学习在现实世界中应用领域驱动设计工具和模式的策略，包括在既有项目和不太理想的环境中。

## 战略分析

按照我们对领域驱动设计模式和实践的探索顺序，在组织中引入 DDD 的最佳起点是投入时间了解组织的业务战略和系统架构的当前状态。

### 理解业务领域

首先，确定公司的业务领域：

* 组织的业务领域是什么？
* 组织的客户是谁？
* 组织为客户提供什么样的服务，或价值？
* 组织与哪些公司或产品竞争？

回答这些问题会让你对公司的高层目标有一个鸟瞰视图。接下来，"放大" 该领域，寻找组织为实现其高层目标而采用的业务构件：子域。

一个很好的初始启发式方法是公司的组织结构图：它的部门和其他组织单位。检查这些部门如何合作以允许公司在其业务领域中竞争。

此外，寻找特定类型的子域的迹象。

#### 核心子域

要确定公司的核心子域，请寻找它与竞争对手的区别：

*  该公司是否拥有竞争对手所缺乏的 "秘方"？例如，知识产权，如专利和自有算法？
*  请记住，竞争优势以及核心子域不一定是技术性的。公司是否具有非技术性竞争优势例如，是否有能力雇用顶尖人员，完成独特的艺术设计，等等？

另一个强大但有点不幸的核心子域启发式方法是识别设计上最差的软件组件--那些所有工程师都讨厌的大泥球，这些大泥球由于伴随的业务风险，企业因此不愿意从头开始重写它们。这里的关键是，遗留系统不能用一个现成的系统（就像通用的子域）来代替，对遗留系统的任何修改都会带来商业风险。

#### 通用子域

为了识别通用子域，需要寻找现成的解决方案、订阅服务或开放源码软件的整合。正如你在第 1 章中所学到的，相同的现成解决方案应该可供竞争公司使用，并且那些利用相同解决方案的公司应该不会对你的公司产生业务影响。

#### 支撑子域

对于支撑子域，要寻找剩余的软件组件，这些组件不能用现成的解决方案替代，也不能直接提供竞争优势。如果支撑子域的代码处于粗糙状态，那么它所引发的软件工程师的情绪反应会较轻，因为它的变化并不频繁。所以，支撑子域中不理想的软件设计的影响并不像核心子域中那样严重。

你不需要确定所有的核心子域。这样做是不现实的，甚至是不可能的，即使对一个中等规模的公司来说也是如此。相反，你需要明确整体结构，并且要更密切关注与你所从事的软件系统最相关的子域。

### 探索当前设计

一旦熟悉了问题域，就可以继续研究解决方案及其设计决策。首先，从高层组件开始。这些不一定是 DDD 意义上的限界上下文，而是用来将业务领域分解成子系统的边界。

你要寻找的特征是组件的已解耦生命周期。即使这些子系统是在同一个源码控制库（mono-repo）中管理的，或者如果所有组件都位于同一单体源码库中，请检查哪些组件可以独立于其他组件进行演化、测试和部署。

#### 评估战术设计

对于每个高层组件，检查它包含哪些业务子域，以及采取了哪些技术设计决策：用了什么模式来实现业务逻辑和定义组件的架构？

该解决方案是否符合问题的复杂性？是否有一些领域需要更精细的设计模式？反之，是否有任何子域有可能偷工减料或使用现有的、现成的解决方案？利用这些信息来做出更明智的战略和战术决策。

#### 评估战略设计

使用高层组件的知识来绘制当前设计的上下文映射，就像这些高层组件是限界上下文一样。识别并跟踪组件间在限界上下文整合模式方面的关系。

最后，分析生成的上下文映射并从领域驱动设计的角度评估架构。是否存在不太理想的战略设计决策？例如：

* 多个团队在同一个高级组件上工作
* 核心子域的重复实现
* 由外包公司实施了核心子域
* 由经常性的整合失败而产生的摩擦
* 从外部服务和遗留系统蔓延而来的尴尬模型

这些洞见是规划现代化设计（design modernization）战略的一个很好的出发点。但首先，基于对问题（业务领域）和解决方案（当前设计）空间的更深入的了解，去寻找丢失的领域知识。正如我们在第 11 章中所讨论的，业务领域的知识会因为各种原因而丢失。这个问题在核心子域中很普遍，也很严重，因为那里的业务逻辑既复杂又关键。如果你遇到了这种情况，推进事件风暴会议，并试图恢复领域知识。同时，将事件风暴会议作为培养通用语言的基础。

## 现代化策略

在 "大重写" 的努力中，工程师们试图从头开始重写系统，在这次正确地设计和实现整个系统，但却很少成功。而管理层更是很少支持这样的架构改造。

改善现有系统设计的一个比较安全的方法是，从大处着眼，从小处着手。正如 Eric Evans 所说，并不是所有的大型系统都被设计得很好。这是一个我们必须接受的事实，因此我们必须战略性地决定在现代化工作方面的投资方向。做出这一决定的前提条件是要有划分了系统子域的一系列边界。边界并不一定是物理的，能使每个子域可以成为一个完整的限界上下文。相反，首先要确保至少逻辑边界（命名空间、模块和包，依赖技术栈）与子域的边界一致，如图 13-1 所示。

<img src=images/figure13-1.png />
图 13-1. 重新组织限界上下文的模块以反映业务子域的边界，而不是技术实现模式 <br><br>

调整系统的模块是一种相对安全的重构形式。你不是在修改业务逻辑，只是在一个更有条理的结构中重新定位类型。也就是说，要确保通过全类型名称的引用，如库的动态加载、反射等，不会遭到破坏。

此外，跟踪子域的业务逻辑在不同的代码库中实现；数据库中的存储过程、无服务函数等等。确保在这些平台上也能引入新的边界。例如，如果一些逻辑是在数据库的存储过程中处理的，要么重新命名这些程序以反映它们所属的模块，要么引入一个专门的数据库模式并重新定位这些存储过程。

### 战略现代化

正如我们在第10章中所讨论的，过早地将系统分解成尽可能小的限界上下文可能会有风险。我们将在下一章中更详细地讨论限界上下文和微服务。现在，寻找可以通过将逻辑边界转化为物理边界获得最大价值的地方。图 13-2 显示了通过将逻辑边界转化为物理边界来提取限界上下文的过程。

要问自己的问题：

* 多个团队是否在同一个代码库上工作？如果是这样，通过为每个团队定义限界上下文来解耦开发生命周期。
* 不同的组件是否正在使用相互冲突的模型？如果是的话，将冲突的模型重新定位到独立的限界上下文中。

<img src=images/figure13-2.png />
图 13-2. 通过将逻辑边界转换为物理边界来提取限界上下文 <br><br>

当满足最低要求的限界上下文出现时，检查它们之间的关系和集成模式。看看在不同的限界上下文下工作的团队是如何沟通和协作的。特别是当他们通过临时或类似共享内核的集成进行交流时，这些团队是否有共同的目标和足够的协作水平？

注意上下文集成模式可以解决的问题：

*客户-供应商关系*

正如我们在第 11 章中所讨论的，组织的成长会使以前的沟通和协作模式失效。寻找那些为多个工程团队的 *合作关系* 而设计的组件，但这种合作关系已不再持续。将其重构为适当的客户-供应商关系类型（遵奉者，防腐层，或开放主机服务）。

*防腐层*

防腐层对于保护限界上下文不受遗留系统的影响是很有用的，特别是，当遗留系统使用低效的模型时，往往会蔓延到下游的组件。

实现防腐层的另一个常见用例是保护限界上下文不受其使用的上游服务的公共接口的频繁变化影响。

*开放主机服务*

如果一个组件的实现细节的变化经常在系统中产生涟漪，并影响到它的消费者，可以考虑把它变成一个开放主机服务：把它的实现模型与它暴露的公共 API 解耦。

*另谋他路*

特别是在大型企业中，你可能会遇到工程团队之间的摩擦，因为他们必须合作共同开发一个共享功能。如果 "不和谐的苹果" [^1] 功能不是业务关键--也就是说，它不是一个核心子域--团队可以采取 *另谋他路关系*，实施自己的解决方案，来消除摩擦的根源。

### 战术现代化

首先，从战术的角度来看，寻找业务价值和实施策略中最 "痛苦" 的不匹配，例如核心子域实施的与模型复杂度不匹配的模式--事务脚本或活动记录模式。

这些直接影响业务成功的系统组件必须经常被更改，但由于设计不佳，维护和演化起来非常痛苦。

### 培育通用语言

成功实现设计现代化的先决条件是业务领域中的领域知识和有效模型。正如我在本书中多次提到的那样，领域驱动设计的通用语言对于实现知识和建立有效的解决方案模型至关重要。

不要忘记领域驱动设计中收集领域知识的捷径：事件风暴。使用事件风暴与领域专家一同构建通用语言并探索遗留代码库，尤其是当代码库是没人真正理解的且没有文档化的一团乱麻时。召集与功能相关的每个人并一同探索业务领域。 事件风暴是恢复领域知识的绝佳工具。

一旦你掌握了领域知识及其模型，就可以决定哪种业务逻辑实现模式最适合所讨论的业务功能。可以使用第 10 章中所描述的设计启发式方法作为起点。你必须做出的下一个决定涉及现代化战略：是逐步替换系统的整个组件（绞杀者模式），还是逐步重构现有的解决方案。

#### 绞杀者模式

绞杀榕，如图 13-3 所示，是一种有着特殊生长模式的热带树科植物：绞杀榕生长在其他树木（宿主树）上。绞杀榕以种子的形式在宿主树的上部枝条上开始其生命。随着绞杀榕的生长，它一路向下，直到在土壤中生根。最后，绞杀榕长出的叶子遮盖了宿主树，导致宿主树死亡。

<img src=images/figure13-3.png />
图 13-3. 生长在宿主树上的绞杀榕（来源：https://unsplash.com/ photos/y_l5tep9wxI） <br><br>

绞杀者迁移模式基于与绞杀榕相同的生长动态，绞杀榕也是此模式名字的来源。做法是创建一个新的限界上下文--也就是绞杀者--用它来实现新的需求，并逐渐将遗留上下文的功能迁移到其中。同时，除了热修补和其他紧急情况外，遗留限界上下文的演化和发展也会停止。最终，所有功能都被迁移到新的限界上下文--即绞杀者--并以此类推，导致其宿主--也就是遗留代码库的死亡。

通常，绞杀者模式会与外观模式（facade）一起使用：外观模式是一个薄的抽象层，其作为公共接口，负责将请求转发给遗留上下文或已完成现代化的限界上下文处理。当迁移完成时--也就是宿主死亡时，外观模式被移除，因为它不再被需要了（见图 13-4）。

<img src=images/figure13-4.png />
图 13-4. 外观层根据将功能从遗留系统迁移到现代化系统的状态转发请求；迁移完成后，外观和遗留系统都将被移除 <br><br>

与每个限界上下文是一个独立的子系统，因此不能与其他限界上下文共享其数据库的原则相反，在实现绞杀者模式时，该规则可以被放宽。现代化上下文和遗留上下文都可以使用同一个数据库，以避免上下文之间复杂的整合，在很多情况下，这可能需要分布式事务--两个上下文都必须基于相同的数据工作，如图 13-5 所示。

可以轻微违背每个限界上下文只有一个数据库这条规则的条件是：最终，而且最好是尽早，遗留的上下文将退役，而数据库将被新的实现独占使用。

<img src=images/figure13-5.png />
图 13-5. 遗留系统和现代化系统都暂时使用同一个数据库工作 <br><br>

除了基于绞杀者模式的迁移之外，另一种方法是在原地对遗留代码库进行现代化改造，也被称为 *重构*。

#### 重构战术设计决策

在第 11 章中，你了解了迁移战术设计决策（译注：也就是演化设计决策）的各个方面。然而，在对一个遗留代码库进行现代化改造时，有两个细微的差别需要注意。

首先，小的渐进式改动比大的重写要安全。因此，不要直接将事务脚本或活动记录重构为事件溯源领域模型。相反，采取中间步骤，设计基于状态的聚合。在寻找有效的聚合边界方面投入精力。确保所有相关的业务逻辑都处在这些边界内。从基于状态的聚合到基于事件的聚合，将比直接迁移到基于事件的聚合中发现的错误的事务性边界要安全得多。

其次，遵循采取小增量步骤的相同推理，重构到领域模型不一定是原子性的更改。相反，你可以逐步引入领域模型模式的元素。

从寻找可能的值对象开始。即使你还没有形成一个全面的领域模型，不可变的对象也可以大大降低解决方案的复杂性。

正如我们在第 11 章中所讨论的，将活动记录重构为聚合并不需要在一夜之间完成。它可以循序渐进地完成。首先，收集相关的业务逻辑。接下来，分析事务性边界。是否有需要强一致性的决策，但却在最终一致的数据上进行操作？或者反过来说，在最终一致性足够的情况下，解决方案是否强制执行强一致性？在分析代码库时，不要忘记这些决定是由业务而不是技术驱动的。只有在彻底分析了事务性需求之后，你才应该设计聚合的边界。

最后，在你重构遗留系统的时候，必要时可以使用防腐层来保护新的代码库不受旧模式的影响，并通过实现一个开放主机服务和发布语言来保护消费者不受遗留代码库的影响。

## 务实的领域驱动设计

正如我们在本章的介绍中所讨论的那样，应用领域驱动设计并不是一个非黑即白尝试。你并不需要使用 DDD 提供的每一个工具。例如，由于某些原因，战术模式可能对你不起作用。也许你更喜欢使用其他的设计模式，因为它们在你的特定领域中效果更好，或者只是因为你发现其他模式更有效。这完全没问题!

只要你分析你的业务领域及其战略，寻找有效的模型来解决特定的问题，最重要的是，根据业务领域的需求做出设计决策：这就是领域驱动的设计!

值得重申的是，领域驱动设计不是关于聚合或值对象。领域驱动设计是关于让你的业务 *领域驱动* 软件 *设计* 决策。

## 推销领域驱动设计

当我在技术会议上介绍此话题的时候，有一个问题几乎每次都会被问到。"这听起来很不错，但是我如何向我的团队和管理层'推销'领域驱动的设计呢？" 这是一个极其重要的问题。

销售是困难的，而且我个人也讨厌销售。尽管如此，如果你仔细想想，设计软件就是销售。我们在向团队、管理层或客户推销我们的想法。然而，一个涵盖如此广泛的设计决策方面的方法论，甚至涉及到了工程领域以外的其他利益相关者，可能是非常难以推销的。

管理层的支持对于在一个组织中进行任何重大的改变都是必不可少的。然而，除非高层管理人员已经熟悉领域驱动设计，或者愿意投入时间来学习该方法的商业价值，否则他们不会把它放在心上，特别是由于 DDD 所带来的工程流程的巨大转变。然而，幸运的是，这并不意味着你不能使用领域驱动设计。

### 暗中进行的领域驱动设计

让领域驱动设计成为你的专业工具箱的一部分，而不是一种组织战略。DDD 的模式和实践是工程技术，既然软件工程是你的工作，那就使用它们吧!

让我们来看看如何将 DDD 纳入你的日常工作，而不至于大动干戈。

#### 通用语言

使用通用语言是领域驱动设计的基本实践。它对于领域知识的发现、交流和有效的解决方案建模是必不可少的。

幸运的是，这种做法非常简单，以至于接近常识了。仔细聆听利益相关者在谈论业务领域时所使用的语言。温和地将建模术语从技术行话转向其业务含义。

寻找不一致的术语并寻求澄清。例如，如果同一事物有多个名称，就寻找其原因。这些不同的模型是否交织在同一个解决方案中？寻找相关上下文，并使之明确。如果意思相同，就遵循常识，寻求使用同一个术语。

另外，尽可能多地与领域专家沟通。这些尝试并不一定需要正式的会议。饮水机和咖啡时间也是很好的沟通方式。与领域专家谈论业务领域。尝试使用他们的语言。寻找理解上的困难并要求澄清。不要担心--领域专家通常很乐意与那些真诚地想了解问题领域的工程师合作。

最重要的是，在你的代码和所有与项目有关的交流中使用通用语言。要有耐心。改变一个组织中已经使用了一段时间的术语需要时间，但最终，通用语言将会被接受。

#### 限界上下文

在探索可能的分解选项时，要解决限界上下文模式所依据的原则：

* 为什么设计面向问题的模型，而不是为所有用例设计一个单一的模型更好？因为 "多合一" 的解决方案很少对任何事情都有效。
* 为什么限界上下文不能承载冲突的模型？因为认知负荷和解决方案的复杂性增加了。
* 为什么多个团队在同一个代码库上工作是个坏主意？因为团队之间有摩擦，合作受阻。

使用限界上下文整合模式中的相同道理：确保你理解每个模式要解决的问题。

#### 战术设计决策

在讨论战术设计模式时，不要诉诸于权威。"让我们在这里使用一个聚合，因为 DDD 的书里是这么说的！" 相反，要诉诸于逻辑。比如说。

* 为什么明确的事务性边界很重要？为了保护数据的一致性。
* 为什么一个数据库事务不能修改一个以上的聚合实例？为了确保一致性边界的正确性。
* 为什么一个聚合的状态不能被外部组件直接修改？为了确保所有相关的业务逻辑被集中在一起，并且是不重复的。
* 为什么我们不能把聚合的一些功能卸装到存储过程中？为了确保没有重复的逻辑。重复的逻辑，特别是在一个系统的逻辑和物理上相距甚远的组件中，往往会出现不同步，导致数据损坏。
* 为什么我们要争取小的聚合边界？因为宽泛的事务范围既会增加聚合的复杂性，又会对性能产生负面影响。
* 为什么，我们不能直接将事件写入日志文件，而需要使用事件溯源？因为没有长期的数据一致性保证。

说到事件溯源，当解决方案需要一个事件溯源领域模型时，这种模式的实现可能很难推销。让我们来看看一个可以帮助解决这个问题的绝地武士（Jedi）心法。

#### 事件溯源领域模型

尽管有很多优点，但对很多人来说，事件溯源听起来太激进了。正如我们在本书中所讨论的一切一样，解决方案是让业务领域来驱动这一决定。

与领域专家交谈。向他们展示基于状态和事件的模型。解释事件溯源的区别和优势，特别是在时间方面。通常情况下，他们会对事件溯源提供的洞察力水平感到非常欣喜，并开始自己提倡此模式。

在与领域专家互动的同时，不要忘了努力学习通用语言!

## 结论

在本章中，你学到了在现实生活场景中利用领域驱动设计工具的各种技术：在处理即有项目和遗留代码库时，并不一定要与 DDD 专家团队一起工作。

和新建项目一样，总是从分析业务领域开始。公司的目标和实现目标的战略是什么？利用组织结构和现有的软件设计决策来确定组织的子域和它们的类型。利用这些知识，规划现代化策略。寻找痛点。寻求获得最大的商业价值。通过重新调整或替换相关组件来实现遗留代码的现代化。无论哪种方式，都要逐步进行。大规模的重写会带来更多的风险，而不是商业价值!

最后，即使 DDD 在你的组织中没有被广泛采用，你也可以使用领域驱动设计的工具。使用正确的工具，并且在与同事讨论时，始终贯彻每个模式背后的逻辑和原则。

本章结束了我们对领域驱动设计本身的讨论。在第 Ⅳ 部分，你将了解到 DDD 与其他方法论和模式的相互作用。

## 练习
1.	假设你想把领域驱动的设计工具和实践引入一个既有项目中。你的第一步要做什么？<br>
A.	将所有的业务逻辑重构为事件溯源领域模型。<br>
B.	分析组织的业务领域及其战略。<br>
C.	通过确保系统的组件遵循适当的限界上下文的原则来改进系统的组件。<br>
D.	在一个既有项目中不可能使用领域驱动设计。<br>

2.	在迁移过程中，绞杀者模式在哪些方面与领域驱动设计的一些核心原则相矛盾？<br>
A.	多个限界上下文正在使用共享数据库。<br>
B.	如果现代化的限界上下文是一个核心子域，它的实现就会在新旧实现中重复出现。<br>
C.	多个团队正在处理相同的限界上下文。<br>
D.	A 和 B <br>

3.	为什么将基于活动记录的业务逻辑直接重构到基于事件的领域模型通常不是一个好主意？<br>
A.	基于状态的模型可以更容易地在学习过程中重构聚合的边界。<br>
B.	逐渐引入大的变化更安全。<br>
C.	A 和 B <br>
D.	以上都不是。即使是事务脚本直接重构到一个以事件溯源领域模型中也是合理的。<br>

4.	当你介绍聚合模式时，你的团队问为什么聚合不能直接引用所有可能的实体，从而使从一个地方遍历整个业务领域成为可能。你如何回答他们呢？<br>


[^1]: 译注：金苹果事件（英语：Golden Apple of Discord），是希腊神话中一场间接导致特洛伊战争的，发生在三女神之间的纠纷。