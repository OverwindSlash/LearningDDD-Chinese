## 第 4 章
# 集成限界上下文

限界上下文模式不仅可以保护通用语言的一致性，还可以进行建模。你无法在不指定目的（边界）的情况下构建模型。边界划分了语言的责任。限界上下文中的通用语言可以对业务领域进行建模以解决特定问题。另一个限界上下文的可以表示相同的业务实体，但对它们进行的建模解决的是不同的问题。

此外，虽然不同限界上下文中的模型可以独立的被实现和演化。但限界上下文本身并不会孤立的存在。就像一个系统不能由互相孤立的部件组成一样——这些组件必须相互交互才能实现系统的总体目标——同样，在限界上下文中实现也是如此。虽然它们可以独立演化，但它们必须相互集成。因此，在限界上下文之间，总会有一些接触点。这些接触点被称为 *契约*。

对契约的需求源于限界上下文中模型和语言的差异。由于每个契约都会影响到不止一方，因此需要对它们进行定义和协调。此外，根据定义，两个限界上下文使用的是不同的通用语言。哪种语言将被用于集成目的？这些集成问题应该由解决方案的设计来评估和解决。

在本章中，你将学习用于定义限界上下文之间关系和集成的领域驱动设计模式。这些模式是由在限界上下文之上工作的团队之间的协作方式驱动的。我们将把这些模式分为三组，每组代表一种团队合作的类型：合作、客户-供应商以及另谋他路。

## 协作模式
协作模式与具有良好沟通的团队所实现的限界上下文相关。

在最简单的情况下，这些都是由一个团队所实现的限界上下文。这也适用于目标相互依赖的团队，其中一个团队的成功取决于另一个团队的成功，反之亦然。同样，这里的主要标准是团队沟通和协作的质量。

让我们来看一下适合协作团队的两种 DDD 模式：合作关系和共享内核模式。

### 合作关系
在合作关系模式中，限界上下文之间的集成是以一种临时的方式进行协调的。第一个团队可以通知第二个团队有关 API 的更改，第二个团队将进行协作和适应——没有扯皮或冲突（见图 4-1）。

<img src=images/figure4-1.png />
图4-1. 合作关系模式 <br><br>

这里关于上下文集成的协调是双向的。不会只有一个团队决定用于定义契约的语言。团队间可以解决分歧并选择最合适的解决方案。同时，双方合作解决任何可能出现的集成问题。任何一个团队都没有兴趣去阻挠另一个团队。

完善的协作实践、高度的承诺以及团队之间的频繁同步，是以这种方式成功整合的必要条件。从技术角度来看，为了进一步减少上下文之间集成的反馈循环（feedback loop），需要对两个团队实施的变更进行持续集成。

这种模式可能不适合于地理位置分散的团队，因为它将会带来同步和沟通上的挑战。

### 共享内核
尽管限界上下文是模型的边界，但仍有可能出现这样的情况：一个子域中的某个模型，或者它的一部分，将在多个限界上下文中被实现。共享模型是针对所有限界上下文的需求而设计的，强调这一点至关重要。此外，共享模型必须在所有使用它的限界上下文中保持一致。

作为例子，考虑一个企业系统，它使用一个量身定做的模型来管理用户的权限。每个用户的权限可以被直接授予或从他们所属的某个组织单位继承。此外，每个限界上下文都可以修改授权模型，每个限界上下文应用的更改也必然影响使用该模型的所有其他限界上下文（见图 4-2）。

<img src=images/figure4-2.png />
图 4-2. 共享内核 <br><br>

#### 共享的范围
重叠的模型耦合了参与其中的限界上下文的生命周期。对共享模型所做的更改会对所有相关限界上下文都产生直接的影响。因此，为了最大限度地减少变化的级联效应，应该对重叠模型加以限制，只暴露模型中两个限界上下文都必须实现的部分。理想情况下，共享内核应该只包含用来跨越限界上下文边界进行传递的集成契约和数据结构。

#### 实现
共享内核的实现方式使得对其源代码的任何修改都会立即反映在所有使用它的限界上下文中。

如果组织使用的是单一代码仓库的形式，这就是多个限界上下文引用相同的源文件。如果使用共享代码仓库不具备可行性，则共享内核可以被提取到一个专门的项目中，并作为一个链接库在限界上下文中被引用。无论使用哪种方式，每次对共享内核的更改都必须触发所有受影响的限界上下文的集成测试。

由于共享内核属于多个限界上下文，因此需要对更改进行不断的集成。未将共享内核的变化传导给所有相关的限界上下文会导致模型中的不一致：限界上下文可能依赖于共享内核的陈旧实现，这将导致数据损坏和/或运行时问题。

#### 何时使用共享内核
共享内核模式的首要适用性准则是复制成本与协调成本之间的对比。由于该模式在参与的限界上下文之间引入了强依赖性，因此只有当复制的成本高于协调的成本时，才可以应用它（译注：共享内核属于协调的方式，应尽可能使用复制的方式来降低耦合）。换句话说，只有在复制变更所花费的努力（译注：此变更应用在两个限界上下文中各自的共享模型副本上），比协调变更花费更多时（译注：此变更应用在共享代码库中的共享模型上）。

集成和复制成本之间的差异取决于模型的易变性。变化越频繁，复制成本就越高。因此，共享内核自然会被应用于变化最大的子域：核心子域。

从某种意义上说，共享内核模式与上一章介绍的限界上下文原则相矛盾。如果参与的限界上下文不是由同一个团队实现的，那么引入共享内核就与一个限界上下文应只由一个团队拥有的原则相矛盾。重叠模型（共享内核）实际上是由多个团队共同开发的。

这就是为什么使用共享内核必须要有合理理由的原因。共享内核只是一个务实的例外，应该被仔细的考量。实现共享内核的一个常见用例是，当沟通或协作问题妨碍了实现合作关系模式时：例如，由于地理限制或组织政治。在没有良好协调的情况下去实现一个紧密关联的功能，将导致集成问题、不同步的模型以及关于哪个模型设计得更好的争论。尽量减少共享内核的范围，控制级联变化的范围，为每个变化触发集成测试是一种强制尽早检测集成问题的手段。

应用共享内核模式的另一个常见情况，尽管是临时性的，是对一个遗留系统的逐步现代化改造。在这种情况下，共享代码库可以成为一种实用的过渡解决方案，用于逐渐将系统分解为限界上下文。

最后，共享内核非常适合集成由同一团队拥有和实现的限界上下文。在这种情况下，限界上下文的临时集成（合作关系）可以随着时间的推移"冲淡"上下文的边界。共享内核可用于明确定义限界上下文的集成契约。

## 客户-供应商模式
我们要研究的第二组协作模式是客户-供应商模式。如图 4-3 所示，限界上下文之一（服务供应商）为其客户提供服务。服务供应商是“上游”，客户或消费者是“下游”。

<img src=images/figure4-3.png />
图4-3. 客户-供应商关系 <br><br>

与合作关系的情况不同，两个团队（上游和下游）都可以独立的成功。因此，在大多数情况下，我们存在决定权上的不平衡：上游或下游团队谁都可以决定集成契约的使用方式。

本节将讨论解决此类决定权的三种有差异的模式：遵奉者、防腐层和开放主机服务模式。

### 遵奉者
在某些情况下，权力平衡偏向于上游团队，他们没有真正的动机来支持其客户的需求。相反，它只提供根据自己的模型定义的集成契约——要么接受，要么离开。这种权力的不平衡可能是由于，集成是由组织外部的服务提供者提供，或者仅仅是由于组织政治。

如果下游团队能够接受上游团队的模型，则限界上下文的关系称为 *遵奉者*。下游遵从上游限界上下文的模型，如图 4-4 所示。

<img src=images/figure4-4.png />
图4-4. 遵奉者关系 <br><br>

下游团队决定放弃部分自主权，可能有多种理由。例如，上游团队暴露的契约可能是行业标准、成熟的模型，也可能只是足够好地满足下游团队的需求。

下一个模式解决的是消费者不愿意接受供应商提供的模型的情况。

### 防腐层
和遵奉者模式一样，这种关系中的权力平衡仍然向上游服务倾斜。然而，在这种情况下，下游限界上下文并不愿意顺从。相反，它可以通过防腐层将上游限界上下文的模型转化为适合自己需要的模型，如图4-5所示。

<img src=images/figure4-5.png />
图4-5. 通过防腐层进行集成 <br><br>

防腐层模式解决了不希望或不值得努力去遵循供应商模型的情况，例如：

*当下游限界上下文包含核心子域时* <br>
核心子域的模型需要额外的关注，遵循供应商的模型可能会阻碍问题域的建模。

*当上游模型对消费者的需求而言并不具效率或不方便时* <br>
如果限界上下文遵循杂乱的模型，它本身就有变得一团糟的风险。与遗留系统集成时通常会出现这种情况。

*当供应商的契约经常发生变化时* <br>
消费者希望保护自己的模型不受频繁变化的影响。有了防腐层，供应商模型的变化只影响转换机制。

从建模的角度来看，供应商模型的转换将下游消费者与和它的限界上下文无关的外来概念隔离开来。因此，它简化了消费者的通用语言和模型。

在第 9 章中，我们将探讨实现防腐层的不同方式。

### 开放主机服务
这种模式解决了权力向消费者倾斜的情况。供应商有兴趣保护其消费者，并尽可能提供最好的服务。

为了保护消费者不受其实现模型变化的影响，上游供应商将实现模型与公开接口进行解耦。这种解耦允许供应商以不同的速率演化其实现模型和公开模型，如图 4-6 所示。

<img src=images/figure4-6.png />
图4-6. 通过开放主机服务进行集成 <br><br>

供应商的公开接口并不打算遵循其通用语言。相反，它的目的是暴露一个方便消费者的协议，用面向集成的语言表达。因此，这种公开的协议被称为 *发布语言*。

从某种意义上说，开放主机服务模式是防腐层模式的逆转：供应商代替消费者实现其内部模型的转换。

将限界上下文的实现模型和集成模型相解耦，使上游限界上下文可以自由地演化它的实现而不影响下游的上下文。当然，这只有在修改后的实现模型能够被转换成消费者已经在使用的发布语言时才有可能。

此外，集成模型的解耦允许上游限界上下文同时公开多个版本的已发布语言，从而允许消费者逐步迁移到新版本（见图 4-7）。

<img src=images/figure4-7.png />
图4-7. 开放主机服务暴露了多个版本的发布语言 <br><br>

## 另谋他路模式
最后一个协作选项是根本不协作。这种模式的出现有不同的原因，比如在团队不愿意或不能协作的情况下。我们将在这里看看其中的几个。

### 沟通问题
避免协作的一个常见原因是由组织规模或内部政治所造成的沟通困难。当团队难以协作和达成一致时，另谋他路并在多个限界上下文中复制功能可能更具成本效益。

### 通用子域
重复子域的性质也可以成为团队另谋他路的一个原因。当所讨论的是通用子域，并且如果通用方案易于集成，则在每个限界上下文中本地集成它可能更具成本效益。这样的一个例子是日志框架；将其在某个限界上下文中作为服务公开没有太大的意义。集成此类解决方案所增加的复杂性将超过在多个上下文中复制此功能的复杂性。复制功能会比协作的成本更低。

### 模型差异
限界上下文模型的差异也可能是采用另谋他路模式协作的原因。这些模型可能是如此不同，以至于不可能建立遵奉者关系，并且实施防腐层将比复制功能更加昂贵。在这种情况下，团队各自寻找解决方案同样更具成本效益。

<img src=images/general-note.png width=50 />&emsp;&emsp;在集成核心子域时，应该避免另谋他路模式。重复实现这样的子域将违背公司以最有效和最优化的方式实现这些子域的战略。

## 上下文映射图
在分析了系统中限界上下文之间的集成模式之后，我们可以把它们绘制在上下文映射图上，如图4-8所示。

<img src=images/figure4-8.png />
图4-8. 上下文映射图 <br><br>

上下文映射图是系统中限界上下文之间集成模式的可视化表示。这种视觉符号在多个层面上提供了宝贵的战略洞察力：

*高层设计* <br>
上下文映射图提供了系统组件和其实现模型的概述。

*通信模式* <br>
上下文映射图描述了团队之间的通信模式——例如，哪些团队正在互相协作，哪些团队更喜欢“不那么亲密”的集成模式，例如防腐层和另谋他路模式。

*组织问题* <br>
上下文映射图可以洞察组织中的问题。 例如，如果某个上游团队的下游消费者都倾向性于实施防腐层，或者如果所有的另谋他路模式都集中在同一个团队周围？

### 维护
理想情况下，应该从一开始就将上下文映射图引入项目，并持续对其进行更新以反映新添加的限界上下文和对现有上下文的修改。

由于上下文映射图可能包含源自多个团队工作的信息，因此最好将上下文映射图的维护定义为一项公共工作：每个团队负责更新自己与其他限界上下文的集成。

上下文映射图可以作为代码进行管理和维护，如，使用 [Context Mapper](https://contextmapper.org/) 这样的工具。

### 限制
需要注意的是，绘制上下文映射图可能是一项具有挑战性的任务。当系统的限界上下文包含多个子域时，可能会有多种集成模式在起作用。例如，在图4-9中，你能看到两个限界上下文中，有两种集成模式：合作关系和防腐层。

<img src=images/figure4-9.png />
图 4-9. 复杂的上下文映射图 <br><br>

此外，即使限界上下文仅限于单个子域，仍然可以有多种集成模式可能在起作用——例如，如果子域的模块需要不同的集成策略。

## 结论
限界上下文并不是孤立的。它们必须彼此互动。下面的模式定义了集成限界上下文的不同方式。

*合作模式* <br>
限界上下文是以临时的方式进行集成的。

*共享内核* <br>
通过共享具有限制的重叠模型来集成两个或多个限界上下文，此重叠模型属于所有参与其中的限界上下文。

*遵奉者* <br>
消费者遵循服务供应商的模型。

*防腐层* <br>
消费者将服务供应商的模型转化为适合消费者需求的模型。

*开放主机服务* <br>
服务供应商实现了发布语言——一种针对其消费者需求进行优化的模型。

*另谋他路* <br>
复制特定的功能比协作和集成它的成本要低。

限界上下文之间的集成可以在上下文映射图上绘制出来。这个工具可以让人们深入了解系统的高层设计、通信模式和组织问题。

现在，你已经了解了用于分析和建模业务领域的领域驱动设计工具和技术，我们将把视角从战略转向战术。在第二部分中，你将学习到实现领域逻辑、组织高层架构和协调系统组件之间通信的不同方法。

## 练习
1. 哪种集成模式绝不应该用于核心子域？<br>
A. 共享内核 <br>
B. 开放主机服务 <br>
C. 防腐层 <br>
D. 另谋他路 <br>

2. 哪种下游子域更有可能实施防腐层？<br>
A. 核心子域 <br>
B. 支撑子域 <br>
C. 通用子域 <br>
D. B 和 C <br>

3. 哪种上游子域更有可能实现开放主机服务？<br>
A. 核心子域 <br>
B. 支撑子域 <br>
C. 通用子域 <br>
D. A 和 B <br>

4. 从某种意义上说，哪种集成模式违反了限界上下文的所有权边界？<br>
A. 合作关系 <br>
B. 共享内核 <br>
C. 另谋他路 <br>
D. 任何集成模式都不应该打破限界上下文的所有权边界。 <br>