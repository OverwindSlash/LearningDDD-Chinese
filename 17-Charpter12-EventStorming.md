## 第 12 章
# 事件风暴

在本章中，我们将从讨论软件设计模式和技术中抽身出来。相反，我们将专注于一个低技术相关性的建模过程，即 *事件风暴*（EventStorming）。这个过程汇集了我们在前几章中所涉及的领域驱动设计的核心内容。

你将学习事件风暴的过程，如何促进事件风暴研讨会，以及如何利用事件风暴来有效地分享领域知识和构建通用语言。

## 什么是事件风暴

事件风暴是一种低技术相关性的活动，可以让一群人集思广益，并快速建立一个业务流程模型。从某种意义上说，事件风暴是一个分享业务领域知识的战术工具。

事件风暴会议有一个 *范围*（scope）：也就是团队有兴趣探索的业务流程。参与者将该过程作为一系列领域事件进行探索，这些事件由在一个时间轴上的便签纸所表示。一步一步地，这个模型用额外的概念—参与者、命令、外部系统和其他概念—来加强，直到它的所有元素讲述了业务流程如何运作。

## 谁应该参与事件风暴？

> 请记住，研讨会的目标是在尽可能短的时间内学到尽可能多的东西。我们邀请关键人物参加研讨会，我们不想浪费他们宝贵的时间。<br>
> —Alberto Brandolini, 事件风暴研讨会创始人

理想情况下，应该有一个多元化的群体参与到研讨会中。事实上，任何与相关业务领域有关的人都可以参加：工程师、领域专家、产品所有者、测试人员、UI/UX设计师、支持人员等等。随着更多具有不同背景的人的参与，更多的知识也将被发现。

然而，注意不要让小组太大。每个参与者都应该能够为这个过程做出贡献，但这对10人以上的小组来说可能是个挑战。

## 你要为事件风暴做什么准备

事件风暴被认为是一种低技术相关性的研讨会，因为它是用笔和纸完成的--实际上是用很多纸。让我们来看看你需要什么来推进事件风暴会议。

*建模空间*

首先，你需要一个大的建模空间。如图 12-1 所示，一整面墙贴上白纸就是最好的建模空间。一块大白板也能达到目的，但它必须尽可能大--你将需要所有你能获得的建模空间。

<img src=images/figure12-1.png />
图 12-1. 事件风暴的建模空间 <br><br>

*便利贴*

接下来，你需要很多不同颜色的便利贴。这些便利贴将被用来代表业务领域中的不同概念，每个参与者都应该能够自由地添加它们，所以要确保你有足够的颜色，并且足够每个人使用。传统上用于事件风暴的颜色将在下一节中描述。如果可能的话，最好坚持使用这些惯例，以便与目前所有的事件风暴书籍和培训保持一致。

*记号笔*

你还需要可以用来在便利贴上写字的记号笔。同样的，用品不应该成为知识共享的瓶颈--应该有足够多的记号笔供所有参与者使用。

*零食*

一个典型的事件风暴会议会持续约两到四个小时，所以要带一些健康的零食来补充能量。

*房间*

最后，你需要一个宽敞的房间。确保中间没有一张巨大的桌子，这将妨碍参与者自由移动和观察建模空间。此外，椅子也是事件风暴会议的大忌。你希望人们参与并分享知识，而不是坐在一个角落里发呆。因此，如果可能的话，把椅子搬出房间。[^1]

## 事件风暴的流程

一个事件风暴研讨通常会分10个步骤进行。在每个步骤中，模型都会得到额外的信息和概念的充实。

### 第 1 步：非结构化探索

事件风暴始于对领域事件的头脑风暴，这些领域事件与需探索的业务领域相关。*领域事件* 是发生在业务中的有趣的事情。用过去式来表述领域事件是很重要的（见图12-2）--它们描述的是已经发生的事情。

<img src=images/figure12-2.png />
图 12-2. 非结构化探索 <br><br>

在此步骤中，所有参与者都要拿着一堆橙色便签，写下任何能想到的领域事件，并把它们贴在建模板的表面。

在这个早期阶段，没有必要担心事件的排序，甚至没有必要担心冗余。这一步就是要集思广益，找出业务领域中可能发生的事情。

团队应不断的产生领域事件，直到增加新事件的速度明显放缓为止。

### 第 2 步：时间轴

接下来，参与者们仔细研究生成的领域事件，并按照它们在业务领域中出现的顺序组织它们。

这些事件应该从 "快乐路径场景" 开始：描述成功的业务方案流程。

一旦完成了 "快乐路径"，就可以添加替代方案--例如，遇到错误或采取不同业务决策的路径。流程分支可以表示为来自前一个事件的两个不同流程，或者用箭头画在建模板表面，如图12-3所示。

<img src=images/figure12-3.png />
图 12-3. 事件流 <br><br>

这一步也会修正不正确的事件，删除重复的事件，当然，如果有必要，也可以添加缺失的事件。

### 第 3 步：痛点

一旦你把事件组织在一个时间轴上，就可以使用这个长时间轴视图来识别流程中需要注意的点。这些注意点可能是瓶颈，需要自动化的手动步骤，缺失的文件，或缺失的领域知识。

重要的是要明确这些低效的问题点，以便在事件风暴会话的过程中能很方便的回到这些问题，或者在事后解决这些问题。如图 12-4 所示，痛点用旋转的（菱形）粉色便条标记。

<img src=images/figure12-4.png />
图 12-4. 菱形粉色便签，指出流程中需要注意的一个方面：缺少有关在预订过程中如何比较机票价格的领域知识 <br><br>

当然，这一步不是追踪痛点的唯一机会。作为主持人，在整个过程中要注意参与者的意见。当一个问题或担忧被提出时，就将其作为一个痛点记录下来。

### 第 4 步：关键事件

一旦你有了增加了痛点的事件时间表，就可以寻找表明上下文或阶段发生变化的重要业务事件。这些被称为关键事件，并用竖线标记，将关键事件之前和之后的事件分开。

例如，如图 12-5 所示，"购物车已初始化"、"订单已初始化"、"订单已发货"、"订单已交付 " 和 "订单已退回" 代表了创建订单过程中的重大变化。

<img src=images/figure12-5.png />
图 12-5. 事件流中表示上下文变化的关键事件 <br><br>

关键事件是潜在的限界上下文边界的一个指标。

### 第 5 步：命令

领域事件描述的是已经发生的事情，而命令描述的是触发事件或事件流的原因。命令描述了系统的操作，与领域事件相反，它是以指令式的方式表述的。比如说。

* 发布活动
* 回滚事务
* 提交订单

命令写在浅蓝色的便签上，并放在建模空间中它们能产生的事件之前。如果一个特定的命令是由一个特定角色的参与者执行的，那么参与者的信息就会被添加到跟命令相关的黄色小便利贴上，如图 12-6 所示。参与者代表业务领域中的一个用户角色，如客户、管理员或编辑人。

当然，并非所有命令都有关联的参与者。因此，只在明显的地方添加参与者信息。在下一步中，我们将使用可以触发命令的其他实体来扩充模型。

<img src=images/figure12-6.png />
图 12-6. “提交订单” 命令，由客户（参与者）执行，随后是 “订单已初始化”、“运费已计算” 和 “订单已发货” 事件 <br><br>

### 第 6 步：命令

几乎总是会这样，一些命令被添加到模型中，但没有与之相关的具体参与者。在这个步骤中，你要寻找可能执行这些命令的自动化策略。

自动化策略是一种情景，在这种情景中，一个事件会触发一个命令的执行。换句话说，当一个特定的领域事件发生时，一个命令会自动执行。

在建模板上，策略被表示为连接事件和命令的紫色便签，如图12-7中的 "策略" 便签所示。

<img src=images/figure12-7.png />
图 12-7. 当观察到 "发货已批准" 事件时，触发 "发货" 命令的自动化策略 <br><br>

如果有关命令只有在满足某些决策条件时才会被触发，你可以在策略便笺上明确指定决策条件。例如，如果你需要在 "收到投诉" 事件后触发升级命令，但只在收到VIP客户的投诉时，你可以在策略便签上明确说明 "只针对VIP客户" 的条件。

如果事件和命令相距甚远，你可以在建模板上画一个箭头来连接它们。

### 第 7 步：读模型

读模型是领域内的数据视图，参与者用其来做出执命令的决定。读模型可以是系统的某个屏幕、某张报表、某条通知等。

读模型由绿色的便签表示（见图12-8中的 "购物车"便签），上面有支持参与者决策所需的信息来源的简短描述。由于命令是在参与者查看了读模型后执行的，所以在建模板上，读模型被置于命令之前。

<img src=images/figure12-8.png />
图 12-8. 客户（参与者）决定提交订单（命令）所需的 “购物车” 视图（读模型） <br><br>

### 第 8 步：外部系统

这一步是用外部系统来增强模型的功能。*外部系统* 被定义为任何不属于正在探索的领域的系统。它可以执行命令（输入）或被通知事件（输出）。

外部系统用粉红色的便签表示。在图 12-9 中，CRM（外部系统）触发了 "发货" 命令的执行。当发货被批准时（事件），它通过一个策略被传达给 CRM（外部系统）。

<img src=images/figure12-9.png />
图 12-9. 外部系统触发命令的执行（左）和批准事件被传达给外部系统（右）。 <br><br>

在这一步结束时，所有的命令都应该由参与者执行，由策略触发，或由外部系统调用。

### 第 9 步：聚合

一旦所有的事件和命令都被表示出来，参与者就可以开始思考如何将相关的概念组织到聚合中。*聚合* 接收命令并产生事件。

聚合表示为大的黄色便签，左边是命令，右边是事件，如图 12-10 所描述。

<img src=images/figure12-10.png />
图 12-10. 以聚合方式组织的命令和领域事件 <br><br>

### 第 10 步：限界上下文

事件风暴过程的最后一步是寻找相互关联的聚合，因为它们代表了密切相关的功能，或者因为它们是通过策略相互耦合的。聚合组形成了限界上下文边界的天然候选者，如图 12-11 所示。

<img src=images/figure12-11.png />
图 12-11. 将系统分解为限界上下文的可能结果 <br><br>

## 变体

Alberto Brandolini，事件风暴研讨会的创建者，将事件风暴过程定义为 *指导原则*，而不是 *硬性规定*。你可以自由地尝试这个过程，找到最适合你的 "配方"。

根据我的经验，在组织中引入事件风暴时，我更喜欢从探索业务领域的大局开始，按照步骤 1（非结构化探索）到步骤 4（关键性事件）。由此产生的模型涵盖了公司业务领域的广泛范围，为通用语言打下了坚实的基础，并为限界上下文划定了可能的边界。

在获得大局观并确定不同的业务流程后，我们继续为每个相关的业务流程提供专门的事件风暴过程--这次是按照所有的步骤来构建整个流程。

在一个完整的事件风暴过程结束时，你将拥有一个描述了业务领域中事件、命令、聚合、甚至可能的限界上下文的模型。然而，所有这些都只是一个小奖励。事件风暴会议的真正价值在于过程本身--不同利益相关者之间的知识共享、业务心智模型的统一、冲突模型的发现，以及最后但并非最不重要的，通用语言的制定。

由此产生的模型可以作为实现事件溯源领域模型的基础。是否走这条路的决定取决于你的业务领域。如果你决定实现事件溯源领域模型，你就有了限界上下文的边界、聚合，当然还有所需领域事件的蓝图。

## 何时使用事件风暴

研讨会会因为很多原因而举行：

*构建通用语言*

随着小组合作建立业务流程的模型，他们本能地同步术语并开始使用相同的语言。

*建模业务过程*

事件风暴过程是建立业务流程模型的一种有效方式。由于它是基于面向 DDD 的构建模块的，所以它也是发现聚合和限界上下文边界的有效方式。

*探索新的业务需求*

你可以使用事件风暴来确保所有参与者在新功能方面处于同一起跑线上，并揭示出业务需求中没有涵盖的边缘案例。

*揭示领域知识*

随着时间的推移，领域知识可能会丢失。这在需要现代化的遗留系统中尤为突出。事件风暴是一种有效的方法，可以将每个参与者持有的知识合并成一个统一的画面。

*探索改进现有业务流程的方法*

对业务流程提供端到端的视图，并提供关注低效率和改善流程的机会所需的视角。

*新的团队成员加入*

与新的团队成员一起主持事件风暴会议，是扩展他们领域知识的一个好方法。

除了何时使用事件风暴外，重要的是关注到何时不使用它。当你所探索的业务流程是简单或明显的，例如遵循一系列连续的步骤，没有任何有趣的业务逻辑或复杂性，那么事件风暴就不会提供明显的帮助。

## 小贴士

当与一群从未做过事件风暴的人一起主持事件风暴会议时，我更喜欢从快速预览这个过程开始。我解释我们要做什么，我们要探索的业务流程，以及我们将在研讨会上使用的建模元素。随着我们使用这些元素 —— 领域事件、命令、参与者等等 —— 我构建一个图例，如图 12-12 所示，用我们将使用的便签和标识来帮助参会者记住颜色代码。在研讨会期间，所有参会者都应该可以看到图例。

<img src=images/figure12-12.png />
图 12-12. 描绘事件风暴过程中各种要素的图例，写在相应的便签纸上 <br><br>

## 关注动态

随着研讨会的进行，跟踪小组的能量表现很重要。如果活力减弱，看看你是否能通过提问重新点燃这个过程，或者是否是时候进入研讨会的下一个阶段。

请记住，事件风暴是一个团体活动，所以要确保它被当作团体活动来处理。确保每个人都有机会参与到建模和讨论中。如果你注意到一些参与者在小组中畏首畏尾，试着让他们参与到这个过程中来，询问有关模型的当前状态。

事件风暴是一项紧张的活动，在某些时候，小组会需要休息一下。在所有参会者都回到房间之前，不要继续会议。通过对模型的当前状态进行检查来恢复这个过程，使小组回到一个合作的建模氛围中。

## 远程事件风暴

事件风暴是作为一种低技术相关性的活动而发明的，人们在同一个房间里一起互动和学习。研讨会的创建者 Alberto Brandolini 经常反对远程进行事件风暴，因为当小组不在同一地点时，不可能达到相同的参与水平，因此也不可能实现协作和知识共享。

然而，随着 2020 年 COVID-19 大流行病的发生，短期不可能再有面对面的会议和进行事件风暴了。一些工具试图实现远程事件风暴会议的合作和推进。在撰写本文时，其中最引人注目的是 miro.com。在进行在线事件风暴时，要有更多的耐心，并考虑到由此产生的不太有效的沟通。

此外，我的经验表明，远程事件风暴会议在参与人数较少的情况下更有成效。虽然可以有多达 10 人参加现场的事件风暴会议，但我更倾向于将在线会议限制在 5 名参与者。当你需要更多的参与者来贡献他们的知识时，你可以举行多个会议，并在之后比较和合并所产生的模型。

在情况允许的情况下，再回到面对面的事件风暴。

## 结论

事件风暴是一个基于协作的研讨会，用于建立业务流程模型。除了产生的模型外，它的主要好处是知识共享。在会议结束时，所有参会者将同步他们对商业流程的心智模型，并为使用通用语言迈出第一步。

事件风暴就像骑自行车。通过实践来学习比在书上读到它要容易得多。尽管如此，研讨会还是很有趣，也很容易促成。你不需要成为事件风暴的黑带就可以开始学习。只要促进会议的进行，遵循步骤，并在过程中学习。

## 练习
1. 谁应该被邀请参加事件风暴会议？<br>
A. 软件工程师 <br>
B. 领域专家 <br>
C. QA 工程师 <br>
D. 对你想探索的业务领域有了解的所有利益相关者 <br>

2. 什么时候是进行事件风暴会议的好时机？<br>
A. 为了构建通用语言 <br>
B. 为了探索一个新的业务领域 <br>
C. 为了找回遗失的既有项目的知识 <br>
D. 为了迎接一个新的团队成员 <br>
E. 为了发现优化业务流程的方法 <br>
F. 以上所有答案都是正确的 <br>

3. 你可以从事件风暴会议中获得什么成果？<br>
A. 对业务领域有更好的共识 <br>
B. 为通用语言奠定坚实的基础 <br>
C. 揭示了对业务领域理解的盲点 <br>
D. 一个基于事件的模型，可以用来实现领域模型模式 <br>
E. 以上所有，但取决于研讨会的目的 <br>


[^1]: 当然，这不是硬性规定。如果发现一些参与者难以长时间站立，请留下几把椅子。