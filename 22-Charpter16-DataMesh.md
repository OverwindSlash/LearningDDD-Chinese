## 第 16 章
# 数据网格

在本书中，到目前为止，我们已经讨论了用于建立业务系统的模型。业务系统实现了实时交易，操纵系统数据并协调其与环境的日常交互。这些模型就是在线事务处理（OLTP）数据。另一种值得关注和适当建模的数据类型是在线分析处理（OLAP）数据。

在本章中，你将了解到被称为数据网格的分析性数据管理架构。你将看到基于数据网格是如何工作的，以及它与更传统的 OLAP 数据管理方法有何不同。最终，你将看到领域驱动设计和数据网格是如何相互适应的。但首先，让我们看看这些分析性数据模型是什么，以及为什么我们不能将业务模型重用于分析用例。

## 分析性数据模型 VS 事务性数据模型

他们说知识就是力量。分析数据可以让公司有能力利用积累的数据来洞察如何优化业务，如何更好地理解客户的需求，甚至通过训练机器学习（ML）模型来做出自动决策。

分析模型（OLAP）和业务模型（OLTP）服务于不同类型的消费者，能够实现不同类型的用例，因此在设计上也遵循不同的设计原则。

业务模型是围绕系统业务领域的各种实体建立的，实现了它们的生命周期，并协调了它们之间的交互。这些模型，如图 16-1 所示，是为业务系统服务的，因此必须进行优化以支持实时业务交易。

<img src=images/figure16-1.png />
图 16-1. 描述业务模型中实体之间关系的关系数据库架构 <br><br>

分析模型的设计是为了提供对业务系统的不同见解。分析模型的目的不是实施实时交易，而是提供对业务活动绩效的洞察，更重要的是，企业如何优化其运营以实现更大的价值。

从数据结构的角度来看，OLAP 模型忽略了单个业务实体，而是通过对事实表（fact tables）和维度（dimension tables）表进行建模来关注业务活动。接下来，我们将仔细研究这些表格。

### 事实表

事实代表已经发生了的业务活动。事实与领域事件的概念类似，都是描述过去发生的事情。然而，与领域事件相反，在风格上没有要求将事实命名为过去式的动词。然而，事实代表了业务流程的活动。例如，事实表 Fact_CustomerOnboardings 将包含每个新进客户的记录，Fact_Sales 包含每个已提交的销售记录。图 16-2 显示了一个事实表的例子。

<img src=images/figure16-2.png />
图 16-2. 包含了公司服务台已解决的案件记录的事实表 <br><br>

另外，与领域事件类似，事实记录永远不会被删除或修改：分析性数据是只需追加数据：表达当前数据已过时的唯一方法是追加一个具有当前状态的新记录。考虑一下图 16-3 中的事实表 Fact_CaseStatus。它包含随时间变化的支持服务请求状态的测量值。事实名称中没有明确的动词，但是事实所捕获的业务流程就是处理支持服务案件的过程。

<img src=images/figure16-3.png />
图 16-3. 描述支持服务案件生命周期中状态变化的事实表 <br><br>

OLAP 和 OLTP 模型之间的另一个重要区别是数据的颗粒度。业务系统需要最精确的数据来处理业务交易。对于分析模型来说，在许多用例中，聚合的数据更有效率。例如，在图 16-3 所示的 Fact_CaseStatus 表中，你可以看到快照是每30分钟获取一次。使用该模型的数据分析师决定什么级别的颗粒度最适合他们的需要。针对测量的每次更改（例如，案件数据的每次更改）都创建事实记录在某些情况下是浪费的，在其他情况下甚至在技术上是不可能的。

### 维度表

分析模型的另一个重要组成部分是维度。如果事实表示业务流程或操作（动词），则维度描述了一个事实（形容词）。

维度被设计用来描述事实的属性，并作为外键从事实表到维度表被引用。作为维度建模的属性是在不同事实记录中重复出现的任何测量值或数据，并且不能只用一列来表示。例如，图 16-4 中的模式用维度增强了 SolvedCases 事实。

<img src=images/figure16-4.png />
图 16-4. 由其维度表包围的SolvedCases事实表 <br><br>

维度高度范式化的原因是分析系统需要支持灵活的查询。这是业务模型和分析模型的另一个区别。可以预测一个业务模型将如何被查询以支持业务需求。分析模型的查询模式是不可预测的。数据分析师需要灵活的方式来观察数据，而且很难预测未来会执行什么查询。因此，范式化可以支持动态查询和过滤，并对不同维度的事实数据进行分组。

### 分析模型

图 16-5 中描述的表结构被称为 *星型架构*（star schema）。它基于事实和维度之间的多对一关系：每个维度记录被许多事实使用；一个事实的外键指向一个维度记录。

<img src=images/figure16-5.png />
图 16-5. 事实及其维度之间的多对一关系 <br><br>

另一个占主导地位的分析模型是雪花架构（snowflake schema）。雪花架构也基于相同的构建模块：事实和维度。然而，在雪花架构中，维度是多层次的：每个维度被进一步规范化为更精细的维度，如图 16-6 所示。

由于额外的范式化，雪花架构将使用更少的空间来存储维度数据，并且更易维护。然而，查询事实的数据将需要连接更多的表，因此需要更多的计算资源。

星形和雪花架构都允许数据分析师分析业务表现，以获得可优化、可融入商业智能（BI）报告的洞察力。

<img src=images/figure16-6.png />
图 16-6. 雪花架构中的多层次维度 <br><br>

## 分析数据管理平台

让我们把讨论从分析性建模转移到支持生成和服务分析性数据的数据管理架构。在本节中，我们将讨论两种常见的分析数据架构：数据仓库和数据湖。你将学习每种架构的基本工作原理，它们之间有什么不同，以及每种方法的挑战。对这两种架构工作原理的了解将为讨论本章的主要话题奠定基础：数据网格范式及其与领域驱动设计的相互作用。

### 数据仓库

数据仓库（DWH）的架构相对简单明了。从企业的所有运营系统中提取数据，将源数据转化为分析模型，并将结果数据加载到一个面向数据分析的数据库中。这个数据库就是数据仓库。

这种数据管理架构主要是基于提取-转换-加载（ETL）脚本。数据可以来自各种来源：业务数据库、事件流、日志等等。除了将源数据转换为基于事实/维度的模型外，转换步骤还可能包括其他操作，如删除敏感数据、去除重复记录、重新排序事件、汇总细粒度事件等。在某些情况下，转换可能需要对进入的数据进行临时存储。这被称为暂存区。

由此产生的数据仓库，如图 16-7 所示，包含了涵盖企业所有业务流程的分析数据。这些数据使用SQL 语言（或其方言之一）暴露出来，由数据分析师和 BI 工程师使用。

<img src=images/figure16-7.png />
图 16-7. 典型的企业数据仓库架构 <br><br>

细心的读者会注意到，数据仓库架构与第 2 章和第 3 章中讨论的一些挑战类似。

首先，数据仓库架构的核心是以建立一个企业范围的模型为目标。该模型应该描述企业所有系统产生的数据，并处理分析数据的不同用例。例如，分析模型能够优化业务，降低运营成本，做出智能业务决策，报告，甚至训练 ML 模型。正如你在第 3 章中所学到的，这种方法对于那些小微企业来说各方面都不切实际。针对手头的任务设计一个模型，如建立报表或训练 ML 模型，才是一个更有效和可扩展的方法。

建立一个包罗万象的模型的挑战，可以通过使用数据集市来部分解决。数据集市是一个数据库，其中包含与明确定义的分析需求相关的数据，如针对单一业务部门的分析。在图 16-8 所示的数据集市模型中，一个集市是由一个 ETL 过程直接从业务系统中填充，而另一个集市则从数据仓库中提取其数据。

<img src=images/figure16-8.png />
图 16-8. 用数据集市增强的企业数据仓库架构 <br><br>

当数据从企业数据仓库抽取到数据集市时，整个企业的模型仍然需要在数据仓库中定义。或者，数据集市可以实施专门的 ETL 流程，直接从业务系统中抽取数据。在这种情况下，生成的模型使得跨不同市场（例如跨不同部门）查询数据变得具有挑战性，因为它需要跨数据库查询并会显着影响性能。

数据仓库架构的另一个挑战是，ETL 过程在分析（OLAP）和操作（OLTP）系统之间产生了强烈的耦合。ETL 脚本所消耗的数据不一定通过系统的公开接口暴露。通常情况下，DWH 系统只是简单地获取驻留在业务系统数据库中的所有数据。业务数据库中使用的架构（schema）并不是一个公开接口，而是一个内部实施细节。因此，数据库架构的轻微变化注定会破坏数据仓库的 ETL 脚本。由于业务系统和分析系统是由相距较远的组织单位实现和维护的，两者之间的沟通是具有挑战性的，并导致了团队之间的很多摩擦。这种沟通模式如图 16-9 所示。

<img src=images/figure16-9.png />
图 16-9. 通过直接从业务数据库获取数据来填充数据仓库，忽略面向集成的公共接口 <br><br>

数据湖架构解决了数据仓库架构的一些不足之处。 

### 数据湖

作为一个数据仓库，数据湖架构是基于相同的概念的，即抽取业务系统的数据并将其转化为分析模型。然而，这两种方法在概念上是有区别的。

基于数据湖的系统抽取了业务系统的数据。然而，这些数据并没有被立即转化为分析模型，而是以原始的形式，即以原始的操作模型保存下来。

最终，原始数据无法满足数据分析师的需求。因此，数据工程师和商业智能工程师的工作是使湖中的数据有意义，并实施 ETL 脚本，生成分析模型并将其送入数据仓库。图 16-10 描述了一个数据湖架构。

<img src=images/figure16-10.png />
图 16-10. 数据湖架构 <br><br>

由于操作系统的数据是以原始形式保存的，并且只在事后进行转换，所以数据湖允许使用多个面向任务的分析模型。一个模型可以用于报告，另一个用于训练ML模型，等等。此外，新的模型可以在未来添加，并以现有的原始数据进行初始化。

这就是说，分析模型的延迟生成增加了整个系统的复杂性。数据工程师实施和支持同一 ETL 脚本的多个版本，以适应不同版本的操作模型的情况并不少见，如图 16-11 所示。

<img src=images/figure16-11.png />
图 16-11. 同一 ETL 脚本的多个版本，以适应不同版本的分析模型 <br><br>

此外，由于数据湖是无数据架构的（schema-less）-- 没有强加给传入数据的数据架构，也没有对传入数据的质量进行控制，所以数据湖的数据在一定的规模下会变得混乱。数据湖使抽取数据变得很容易，但要利用这些数据则困难得多。或者，正如人们常说的，数据湖变成了一个数据沼泽。数据科学家的工作变得复杂得多，要从混乱的数据中找出意义，提取有用的分析数据。

### 数据仓库和数据湖架构的挑战

数据仓库和数据湖架构都是基于这样的假设：为分析而抽取的数据越多，组织获得的洞察力就越强。然而，这两种方法都容易在 "大" 数据的压力下崩溃。业务模式向分析模式的转变，在规模上会汇聚成成千上万个不可维护的、临时的 ETL 脚本。

从建模的角度来看，这两种架构都超越了业务系统的边界，并对其实现细节产生了依赖性。由此产生的与实现模型的耦合在业务和分析系统团队之间产生了摩擦，往往会为了不破坏分析系统 ETL 的工作而阻止了对业务模型的改变。

更糟糕的是，由于数据分析师和数据工程师属于一个独立的组织部门，他们往往缺乏业务系统开发团队所拥有的业务领域的深刻知识。他们不具备业务领域的知识，而主要擅长大数据工具。

最后但并非最不重要的是，在基于领域驱动的设计项目中，与实现模型的耦合尤为突出，在这些项目中，重点是不断发展和改进业务领域模型。因此，业务模型的变化会对分析模型产生不可预见的后果。这样的变化在 DDD 项目中很常见，并且经常导致研发和数据团队之间的摩擦。

数据仓库和数据湖的这些限制激发了一种新的分析性数据管理架构：数据网格。

## 数据网格

从某种意义上说，数据网格是分析数据的领域驱动设计。就像 DDD 的不同模式划定了边界并保护了其中内容，数据网格也定义并保护了分析数据的模型和所有权边界。

数据网格基于四个核心原则：围绕领域分解数据，将数据作为产品，实现自治性，并建立生态系统。让我们来详细讨论每个原则。

### 围绕领域分解数据

数据仓库和数据湖的方法都旨在将企业的所有数据统一到一个大模型中。就像在整个企业范围内的使用同一种业务模型一样，由此产生的分析模型是低效的。此外，从所有系统中收集数据到一个地方，模糊了各种数据元素的所有权界限。

数据网格不是建立一个单一的分析模型，而是要求我们利用在第 3 章中讨论的相同解决方案来针对操作数据：使用多个分析模型并将它们与数据来源对齐。这就自然而然地将分析模型的所有权边界与限界上下文的边界进行了对齐，如图 16-12 所示。当分析模型根据系统的限界上下文进行分解时，分析数据的生成就成为相应产品团队的责任。

<img src=images/figure16-12.png />
图 16-12. 将分析模型的所有权边界与限界上下文的边界对齐 <br><br>

现在，每个限界上下文都拥有它的业务（OLTP）和分析（OLAP）模型。因此，拥有业务模型的同一个团队，现在也负责将业务模型转换为分析模型。

### 将数据作为产品

经典的数据管理架构使人们难以发现、理解和获取高质量的分析数据。这在数据湖的情况下尤为突出。

将数据作为产品的原则要求将分析数据作为一等公民对待。在一个基于数据网格的系统中，分析系统不需要从暧昧的来源（内部数据库、日志文件等）获得操作数据，限界上下文通过明确定义的输出端口为分析数据提供服务，如图 16-13 所示。

<img src=images/figure16-13.png />
图 16-13. 向消费者公开分析数据的多元化（Polyglot）数据端点 <br><br>

分析数据应与任何公开 API 一样被对待：

* 应该很容易发现必要的端点：数据输出端口。
* 分析端点应该有一个明确的模式，描述其所提供的数据及其格式。
* 分析数据应该是可信的，与任何 API 一样，它应该有被定义的和可监测的服务级别协议（SLA）。
* 分析模型应该作为常规的 API 进行版本管理，并相应地管理模型中会破坏集成的变化。

此外，由于分析数据被视为一种产品，它必须满足其消费者的需求。限界上下文的团队负责确保所产生的模型能够满足消费者的需求。与数据仓库和数据湖的架构相反，有了数据网格，对数据质量的责任是最高级别的关注点。

分布式数据管理架构的目标是允许细粒度的分析模型被组合起来，以解决组织的数据分析需求。例如，如果一个商业智能报告应该反映来自多个限界上下文的数据，如果需要的话，它应该能够轻松地获取他们的分析数据，应用本地转换，并产生报告。

最后，不同的消费者可能需要不同形式的分析数据。有些人可能喜欢执行 SQL 查询，有些人喜欢从对象存储服务中获取分析数据，等等。因此，数据产品必须是多元化的，以适应不同消费者需求的格式来提供数据。

### 实现自治性

产品团队应该既能创建自己的数据产品，又能消费由其他限界上下文提供的数据产品。就像在限界上下文的情况下，数据产品应该是可互操作的。

如果每个团队都建立自己的解决方案来服务于分析数据，这将是浪费、低效和难以整合的。为了防止这种情况发生，需要一个平台来抽象出构建、执行和维护可互操作数据产品的复杂性。设计和构建这样一个平台是一项相当大的工程，需要一个专门的数据基础设施平台团队。

数据基础设施平台团队应该负责定义数据产品蓝图、统一访问模式、访问控制和可被产品团队利用的多元化存储以及监控平台，并确保达到 SLA 和分析目标。

### 建立生态系统

创建数据网格系统的最后一步是任命一个联合治理机构，以实现分析数据领域的互操作性和生态系统思维。通常情况下，这将是一个由限界上下文的数据和产品所有者以及数据基础设施平台团队的代表组成的小组，如图 16-14 所示。

<img src=images/figure16-14.png />
图 16-14. 治理组，确保分布式数据分析生态系统可互操作、健康并满足组织的需求 <br><br>

治理小组负责定义规则，以确保一个健康和可互操作的生态系统。这些规则必须适用于所有的数据产品及其接口，该小组的责任是确保整个企业遵守这些规则。

### 结合数据网格和领域驱动设计

这就是数据网格所基于的四个原则。对定义边界的强调，以及对定义好的输出端口背后的实现细节的封装，使得数据网格显然是基于与领域驱动设计相同的原理。此外，一些领域驱动设计模式可以极大地支持数据网格的实现。

首先，通用语言和由此产生的领域知识对设计分析模型至关重要。正如我们在数据仓库和数据湖部分所讨论的，领域知识在传统架构中是缺乏的。

第二，在一个不同于其业务模型的模型中暴露限界上下文的数据，这就是开放主机模式。在这种情况下，分析模型是一种额外的发布语言。

CQRS 模式使得生成同一数据的多个模型变得容易。它可以被利用来将业务模型转化为分析模型。CQRS 模式从零开始生成模型的能力使其很容易同时生成和提供多个版本的分析模型，如图 16-15 所示。

<img src=images/figure16-15.png />
图 16-15. 利用 CQRS 模式以两个不同的数据架构版本同时提供分析数据 <br><br>

最后，由于数据网格结合了不同限界上下文的模型来实现分析用例，业务模型的限界上下文整合模式也适用于分析模型。两个产品团队可以在合作中演化他们的分析模型。还可以实现防腐层，以保护自己免受失效的分析模型的影响。或者，在另一方面，这些团队可以实现另谋他路模式，产生分析模型的重复实现。

## 结论

在本章中，你了解了设计软件系统的不同方面，特别是定义和管理分析数据。我们讨论了分析数据的主流模型，包括星形和雪花架构，以及传统上如何在数据仓库和数据湖中管理数据。

数据网格旨在解决传统数据管理架构的挑战。它的核心是将与领域驱动设计相同的原则应用于分析数据：将分析模型分解为可管理的单元，并确保分析数据可以通过其公开接口被可靠地访问和使用。最终，CQRS 和限界上下文集成模式可以支持实现数据网格。

## 练习

1.	关于交易型（OLTP）和分析型（OLAP）模型之间的差异，以下哪种说法是/是正确的？<br>
A.	OLAP 模型应该比 OLTP 模型提供更灵活的查询选项。<br>
B.	OLAP 模型预计会比 OLTP 模型经历更多的更新，因此必须对写操作进行优化。<br>
C.	OLTP 数据是为实时操作而优化的，而等待 OLAP 查询的响应需要几秒钟甚至几分钟，这是可以接受的。<br>
D.	A 和 C 是正确的。<br>

2.	哪种限界上下文整合模式对于实现数据网格至关重要？<br>
A.	共享内核 <br>
B.	开放主机服务 <br>
C.	防腐层 <br>
D.	合作关系 <br>

3.	哪种架构模式对于实现数据网格是必不可少的？<br>
A.	分层架构 <br>
B.	端口和适配器 <br>
C.	CQRS <br>
D.	架构模式无法支持 OLAP 模型的实现。 <br>

4.	数据网格的定义要求围绕 "领域" 进行数据分解。什么 DDD 术语表示了数据网格的 "领域" ？<br>
A.	限界上下文 <br>
B.	业务领域 <br>
C.	子域 <br>
D.	在 DDD 中，数据网格中的 "领域" 没有对应的词。 <br>







