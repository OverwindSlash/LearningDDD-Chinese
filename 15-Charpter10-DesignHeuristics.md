## 第 10 章
# 设计的启发式方法

“视情况而定” 是软件工程中几乎所有问题的正确答案，但并不真正实用。在本章中，我们将探讨 “视情况” 到底 “视” 的是什么。

在本书的第 I 部分中，你学习了用于分析业务领域和制定战略设计决策的领域驱动设计工具。在第 II 部分中，我们探讨了战术设计模式：实现业务逻辑、组织系统架构以及在系统组件之间建立通信的不同方式。本章是第 I 部分和第 II 部分的衔接。你将学习应用分析工具来驱动各种软件设计决策的启发式方法：也就是（业务）领域驱动的（软件）设计。

不过首先，由于这一章是关于设计的启发式方法的，我们就先来定义一下 *启发式方法* 这个词。

## 启发式方法

启发式方法不是一个硬性规则，可以保证并在数学上证明在 100% 的情况下都是正确的。相反，这是一条经验法则：不能保证完美，但足以满足一个近期目标。换句话说，启发法是一种有效的解决问题的方法，它忽略了许多线索中固有的噪音，而专注于反映在最重要线索中的“阻滞力”。[^1]

本章介绍的启发式方法侧重于不同业务领域的基本属性以及各种设计决策所要解决问题的本质。

## 限界上下文

正如你在第 3 章中所学习的那样，宽边界和窄边界都可以符合有效限界上下文的定义，上下文包含一致的通用语言。但是，限界上下文的最佳大小是多少？鉴于限界上下文经常被等同于微服务，这个问题就显得尤为重要。[^2]

我们是否应该始终争取尽可能小的限界上下文？正如我的朋友 Nick Tune 所说：

> 对于定义服务的边界，有许多有用的、有启示意义的启发式方法。尺寸是其中最没用的一种。

与其使模型成为所需边界大小的函数（向小型限界上下文方向进行优化），不如反其道而行之：将限界上下文的大小视为它所包含的模型的函数。那种没有被封装在单一限界上下文中的变化预示着上下文的边界设计是无效的。不幸的是，重构限界上下文的边界是一项代价高昂的工作，在许多情况下，无效的边界始终无人过问，最终积累导致了技术债务（见图10-1）。

<img src=images/figure10-1.png />
图 10-1. 影响多个限界上下文的更改 <br><br>

当业务领域不为人所知或业务需求频繁变化时，通常会发生使得限界上下文边界失效的更改。正如你在第 1 章中学到的，易变性和不确定性都是核心子域的属性，特别是在实现的早期阶段。我们可以将它作为设计限界上下文边界的启发式方法。

宽广的，或者包含多个子域的限界上下文，使得在其边界或模型上犯的错误变得没那么危险。重构逻辑边界要比重构物理边界的成本低得多。因此，在设计限界上下文时，应该从较宽的边界开始。如果需要，比如当你获得新的领域知识时，可将宽的边界分解成更小的边界。

这种启发式方法主要适用于包含核心子域的限界上下文，因为通用子域和支持子域都更加公式化且易变性要小得多。当创建一个包含核心子域的限界上下文时，你可以通过囊括核心子域最常与之互动的其他子域来保护自己免受不可预见变化的影响。这些被囊括的子域可以是其他的核心子域，甚至是支撑和通用子域，如图10-2所示。

<img src=images/figure10-2.png />
图 10-2. 宽广的限界上下文 <br><br>

## 业务逻辑实现模式

在第 5-7 章中，我们详细讨论了业务逻辑，你学到了四种不同的业务逻辑建模方式：事务脚本、活动记录、领域模型和事件溯源领域模型模式。

事务脚本和活动记录模式都更适合具有简单业务逻辑的子域：例如，支撑子域或集成第三方解决方案的通用子域。这两种模式的区别在于数据结构的复杂性。事务脚本模式可用于简单的数据结构，而活动记录模式有助于封装复杂数据结构与底层数据库的映射。

领域模型及其变体--事件溯源的领域模型，适合具有复杂业务逻辑的子域：核心子域。处理货币交易的核心子域，根据法律规定有义务提供审计日志，或者需要对系统行为进行深入分析的核心子域，由事件溯源领域模型来实现更好。

考虑到所有这些，选择合适的业务逻辑实现模式的有效启发式方法是提出以下问题：

* 子域是否跟踪金钱或其他货币交易，或必须提供一致性的审计日志，或业务需要对其行为进行深入分析？如果是这样，请使用事件溯源领域模型。否则...
* 子域的业务逻辑复杂吗？如果是这样，请实现领域模型。否则...
* 该子域是否包括复杂的数据结构？如果是，请使用活动记录模式。否则...
* 实现一个事务脚本。

由于子域的复杂性与其类型之间有很强的关联性，我们可以使用领域驱动的决策树来可视化启发式方法，如图 10-3 所示。

<img src=images/figure10-3.png />
图 10-3. 业务逻辑实现模式的决策树 <br><br>

我们可以用另一种启发式方法来定义复杂和简单业务逻辑之间的区别。这两种类型的业务逻辑之间的界限并不十分清晰，但这个界限会很有用。一般来说，复杂的业务逻辑包括复杂的业务规则，不变量和算法。而简单的业务主要围绕着输入的验证。评估复杂性的另一个启发式方法涉及通用语言本身的复杂性。它主要是描述CRUD操作，还是描述更复杂的业务流程和规则？

根据业务逻辑及其数据结构的复杂性来确定业务逻辑实现模式，这是验证你对子域类型的判定是否正确的一种方式。假设你认为它是一个核心子域，但与之相配最好的模式是活动记录或事务脚本。或者假设你认为的支撑子域需要一个领域模型或一个事件溯源领域模型。在这些情况下，就是一个极好的机会，你可以重新审视对子域以及业务领域的整体判定。记住，核心子域的竞争优势不一定是技术上的。

## 架构模式

在第 8 章中，你了解到了三种架构模式：分层架构、端口和适配器、以及 CQRS。

知道了预期的业务逻辑实现模式，就可以直接选择一种架构模式。

* 事件溯源领域模型需要 CQRS。否则，系统的数据查询功能将受到极大限制，只能通过其 ID 获取单个实例。
* 领域模型需要端口和适配器架构。否则，分层架构就很难使聚合和值对象做到对持久化细节的忽略。
* 活动记录模式最好与带有额外的应用（服务）层的分层架构相结合。这是用于控制活动记录的逻辑。
* 事务脚本模式可以用一个最小的分层架构来实现，只包含三层。

上述启发式方法的唯一例外是 CQRS 模式。 CQRS 不仅有利于事件溯源领域模型，而且如果子域需要在多个持久化模型中表示其数据，则对任何有类似需求的其他模式也是有利的。

图 10-4 显示了用于根据这些启发式方法选择架构模式的决策树。

<img src=images/figure10-4.png />
图 10-4. 架构模式决策树 <br><br>

## 测试策略

对业务逻辑实现模式和架构模式的了解可以作为启发式方法来选择代码库的测试策略。请看图10-5 所示的三种测试策略。

<img src=images/figure10-5.png />
图 10-5. 关于测试的策略 <br><br>

图中测试策略的区别在于它们所强调的不同类型的测试：单元测试、集成测试和端到端测试。让我们分析一下每种策略和模式应该使用的背景。

### 测试金字塔

经典的测试金字塔强调单元测试，较少的集成测试，甚至更少的端到端测试。领域模型模式的两种变体都适用测试金字塔策略。聚合和值对象是高效测试业务逻辑的绝佳单元。

### 测试钻石

测试钻石最关注的是集成测试。当使用活动记录模式时，根据定义，系统的业务逻辑会分布在服务层和业务逻辑层中。因此，为了专注于两层的整合，测试钻石是更有效的选择。

### 逆向测试金字塔

逆向测试金字塔最关注端到端测试：从头到尾验证应用程序的工作流程。这样的方法最适合实现事务脚本模式的代码库：业务逻辑简单，层数最少，使得验证系统的端到端流程更加有效。

图 10-6 显示了测试策略决策树。

<img src=images/figure10-6.png />
图 10-6. 测试策略的决策树 <br><br>

## 战术设计决策树

业务逻辑模式、架构模式和测试策略的启发式方法可以使用战术设计决策树进行统一和总结，如图 10-7 所示。

<img src=images/figure10-7.png />
图 10-7. 战术设计决策树 <br><br>

正如你所看到的，确定子域类型和遵循决策树会给你一个坚实的起点，以做出基本的设计决定。尽管如此，重要的是要重申，这些仅是启发式方法，而不是硬性规则。每条规则都有例外，更不用说启发式方法了，根据定义，这些方法并不试图在 100% 的情况下都是正确的。

决策树基于我对使用简单工具的偏好，并且仅在绝对必要时才使用高级模式——领域模型、事件溯源领域模型、CQRS 等。另一方面，我也遇到过一些团队，他们在实现事件溯源领域模型方面有着丰富的经验，因此将其用于他们所有的子域。对他们来说，这比使用其他不同的模式更简单。我可以向所有人推荐这种做法吗？当然不行。在我工作过或咨询过的公司中，基于启发式的方法比对每个问题使用相同的解决方案更有效率。

归根结底，这取决于你的具体情况。使用图 10-7 中所示的决策树及其所基于的设计启发式方法作为指导原则，但这并不能替代批判性思维。如果你发现其他启发式方法更适合你，请随时改变指导原则或完全建立你自己的决策树。

## 结论

本章将本书的第 I 和第 II 部分与基于启发式方法的决策框架联系起来。你学会了如何应用业务领域及其子系统的知识来驱动技术决策：选择安全的限界上下文，对应用程序的业务逻辑进行建模，以及明确用于编排每个限界上下文的内部组件之间交互所需的架构模式。最后，我们绕道而行，进入了一个经常引起激烈争论的新话题——什么样的测试更重要——并使用相同的决策框架根据业务领域对不同的测试策略进行了优先级排序。

做出设计决策很重要，但更重要的是随着时间的推移验证决策的价值。在下一章中，我们将把讨论转移到软件设计生命周期的下一个阶段：设计决策的演变。

## 练习
1. 假设你正在实现 WolfDesk（参见前言）的工单生命周期管理系统。它是一个核心子域，需要对其行为进行深入分析，以便随着时间的推移进一步优化算法。你实现业务逻辑和组件架构的初始策略是什么？你的测试策略是什么？<br>

2. 你对 WolfDesk 支持专员的轮班管理模块的设计决策是什么？<br>

3. 为了便于管理专员的轮班，你想使用一个外部供应商实现的为不同地理区域提供公共假期的服务。这个过程通过定期调用外部供应商接口，获取即将到来的公共假期的日期和名称来工作。你将使用什么业务逻辑和架构模式来实现整合？你将如何测试它？

4. 根据你的经验，在本章中介绍的基于启发式方法的决策树中，还可以包括软件开发过程的哪些方面？


[^1]: Gigerenzer, G.、Todd, P. M. & ABC 研究小组（研究小组，马克斯普朗克研究所，德国）。 (1999)。使我们聪明的简单启发式方法。纽约：牛津大学出版社。
[^2]: 第 11 章会专门介绍限界上下文和微服务之间的相互作用。